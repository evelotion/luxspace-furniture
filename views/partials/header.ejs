<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LuxeSpace | Premium Furniture</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />

    <style>
      /* FIX 1: Paksa background HTML jadi hitam agar overscroll/space bawah footer tidak putih */
      html {
        background-color: #151515;
        height: 100%;
      }

      body {
        background-color: #fdfbf7;
        color: #1a202c;
        font-family: "Lato", sans-serif;
        overflow-x: hidden;
        min-height: 100vh; /* Pastikan body minimal setinggi layar */
      }

      h1,
      h2,
      h3,
      .font-serif {
        font-family: "Playfair Display", serif;
      }

      .nav-transparent {
        background: transparent;
        padding: 1rem 0;
      }
      .nav-scrolled {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(16px);
        padding: 1rem 0;
        box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.05);
      }

      .fly-img {
        position: fixed;
        z-index: 100;
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 50%;
        opacity: 0.8;
        pointer-events: none;
        transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1);
      }

      .cart-scroll::-webkit-scrollbar {
        width: 4px;
      }
      .cart-scroll::-webkit-scrollbar-thumb {
        background-color: #cbd5e0;
        border-radius: 4px;
      }
    </style>
  </head>
  <body class="flex flex-col min-h-screen">
    <nav
      id="navbar"
      class="fixed w-full z-50 transition-all duration-500 ease-in-out nav-transparent"
    >
      <div
        class="container mx-auto px-6 flex justify-between items-center relative"
      >
        <a
          href="/"
          class="text-2xl font-serif font-bold tracking-[0.2em] text-gray-900 relative group z-50"
        >
          LUXESPACE.
          <span
            class="absolute -right-3 bottom-1.5 w-1.5 h-1.5 bg-yellow-600 rounded-full opacity-0 group-hover:opacity-100 transition-all duration-300"
          ></span>
        </a>

        <div
          class="flex items-center space-x-8 md:space-x-12 text-xs uppercase tracking-[0.15em] font-medium text-gray-900"
        >
          <a href="/" class="hidden md:inline hover:text-yellow-600 transition"
            >Collections</a
          >

          <% if(currentUser) { %>
          <div class="flex items-center space-x-6">
            <div class="relative group" id="cart-container">
              <button
                onclick="toggleMiniCart()"
                class="relative p-2 hover:text-yellow-600 transition focus:outline-none"
              >
                <svg
                  id="cart-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-6 w-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.5"
                    d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
                  />
                </svg>
                <span
                  id="cart-count"
                  class="absolute top-0 right-0 bg-yellow-600 text-white text-[9px] font-bold w-4 h-4 rounded-full flex items-center justify-center transform scale-0 transition-transform duration-300"
                  >0</span
                >
              </button>

              <div
                id="mini-cart"
                class="absolute right-0 top-full mt-4 w-80 bg-white rounded-2xl shadow-2xl border border-gray-100 opacity-0 invisible transform translate-y-2 transition-all duration-300 overflow-hidden z-[60]"
              >
                <div class="p-4 border-b border-gray-100 bg-gray-50/50">
                  <h4 class="text-sm font-serif font-bold text-gray-900">
                    Shopping Bag
                  </h4>
                </div>

                <div
                  id="mini-cart-items"
                  class="max-h-60 overflow-y-auto cart-scroll p-4 space-y-4"
                >
                  <p class="text-center text-gray-400 text-[10px] py-4">
                    Loading...
                  </p>
                </div>

                <div class="p-4 border-t border-gray-100 bg-gray-50">
                  <div
                    class="flex justify-between text-sm font-bold text-gray-900 mb-4"
                  >
                    <span>Total</span>
                    <span id="mini-cart-total">IDR 0</span>
                  </div>
                  <a
                    href="/cart"
                    class="block w-full bg-gray-900 text-white text-center py-3 rounded-lg text-[10px] uppercase tracking-widest font-bold hover:bg-yellow-600 transition"
                  >
                    View Full Cart
                  </a>
                </div>
              </div>
            </div>

            <div class="relative group h-full flex items-center">
              <button
                class="flex items-center gap-2 text-sm font-serif italic text-gray-900 hover:text-yellow-600 transition focus:outline-none py-2"
              >
                <span>Hello, <%= currentUser.full_name.split(' ')[0] %></span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-3 w-3 pt-1 text-gray-400 group-hover:text-yellow-600 transition transform group-hover:rotate-180 duration-300"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
              </button>

              <div
                class="absolute right-0 top-full pt-2 w-48 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 transform translate-y-2 group-hover:translate-y-0 z-50"
              >
                <div
                  class="bg-white border border-gray-100 rounded-xl shadow-xl overflow-hidden"
                >
                  <div class="py-2">
                    <a
                      href="/profile"
                      class="block px-6 py-3 text-[10px] uppercase tracking-widest text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition flex items-center gap-2"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="1.5"
                          d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                        ></path>
                      </svg>
                      My Profile
                    </a>
                    <a
                      href="/orders"
                      class="block px-6 py-3 text-[10px] uppercase tracking-widest text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition flex items-center gap-2"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="1.5"
                          d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"
                        ></path>
                      </svg>
                      My Orders
                    </a>

                    <div class="border-t border-gray-100 my-1"></div>

                    <a
                      href="/auth/logout"
                      class="block px-6 py-3 text-[10px] uppercase tracking-widest text-red-400 hover:bg-red-50 hover:text-red-600 transition flex items-center gap-2"
                    >
                      <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="1.5"
                          d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                        ></path>
                      </svg>
                      Logout
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <% } else { %>
          <div class="flex items-center space-x-6">
            <a href="/auth/login" class="hover:text-yellow-600 transition"
              >Login</a
            >
            <a
              href="/auth/register"
              class="border border-gray-900 px-6 py-2 rounded-full hover:bg-gray-900 hover:text-white transition"
              >Sign Up</a
            >
          </div>
          <% } %>
        </div>
      </div>
    </nav>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        updateCartData();
      });

      function toggleMiniCart() {
        const dropdown = document.getElementById("mini-cart");
        if (dropdown.classList.contains("invisible")) {
          dropdown.classList.remove("invisible", "opacity-0", "translate-y-2");
          updateCartData();
        } else {
          dropdown.classList.add("invisible", "opacity-0", "translate-y-2");
        }
      }

      async function updateCartData() {
        try {
          const res = await fetch("/cart/api/my-cart");
          const data = await res.json();

          if (data.success) {
            const badge = document.getElementById("cart-count");
            badge.innerText = data.totalItems;
            if (data.totalItems > 0) badge.classList.remove("scale-0");
            else badge.classList.add("scale-0");

            const container = document.getElementById("mini-cart-items");
            const totalEl = document.getElementById("mini-cart-total");

            if (data.items.length === 0) {
              container.innerHTML =
                '<p class="text-center text-gray-400 text-[10px] py-4">Your bag is empty.</p>';
              totalEl.innerText = "IDR 0";
            } else {
              container.innerHTML = data.items
                .map(
                  (item) => `
                            <div class="flex gap-3 items-center">
                                <img src="${
                                  item.image_url
                                }" class="w-12 h-12 rounded object-cover border border-gray-100">
                                <div class="flex-grow">
                                    <p class="text-[11px] font-bold text-gray-900 truncate w-32">${
                                      item.name
                                    }</p>
                                    <p class="text-[10px] text-gray-500">x${
                                      item.quantity
                                    }</p>
                                </div>
                                <p class="text-[10px] font-bold text-gray-900">
                                    ${new Intl.NumberFormat("id-ID").format(
                                      item.price * item.quantity
                                    )}
                                </p>
                            </div>
                        `
                )
                .join("");
              totalEl.innerText =
                "IDR " + new Intl.NumberFormat("id-ID").format(data.grandTotal);
            }
          }
        } catch (err) {
          console.error("Cart error:", err);
        }
      }

      async function addToCartAnimated(btn, productId, imageUrl) {
        try {
          const res = await fetch("/cart/api/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ product_id: productId }),
          });
          const result = await res.json();

          if (!result.success) {
            alert("Please login first!");
            window.location.href = "/auth/login";
            return;
          }
        } catch (e) {
          console.error(e);
          return;
        }

        const cartIcon = document.getElementById("cart-icon");
        if (!cartIcon) return;

        const imgClone = document.createElement("img");
        imgClone.src = imageUrl;
        imgClone.classList.add("fly-img");

        const rectBtn = btn.getBoundingClientRect();
        imgClone.style.top = rectBtn.top + "px";
        imgClone.style.left = rectBtn.left + "px";
        document.body.appendChild(imgClone);

        const rectCart = cartIcon.getBoundingClientRect();

        setTimeout(() => {
          imgClone.style.top = rectCart.top + "px";
          imgClone.style.left = rectCart.left + "px";
          imgClone.style.width = "10px";
          imgClone.style.height = "10px";
          imgClone.style.opacity = "0";
        }, 50);

        setTimeout(() => {
          imgClone.remove();
          updateCartData();

          cartIcon.classList.add("scale-125", "text-yellow-600");
          setTimeout(
            () => cartIcon.classList.remove("scale-125", "text-yellow-600"),
            200
          );
        }, 800);
      }

      window.addEventListener("scroll", () => {
        const navbar = document.getElementById("navbar");
        if (window.scrollY > 50) {
          navbar.classList.remove("nav-transparent");
          navbar.classList.add("nav-scrolled");
        } else {
          navbar.classList.add("nav-transparent");
          navbar.classList.remove("nav-scrolled");
        }
      });
    </script>

    <main class="flex-grow relative z-10"></main>
  </body>
</html>
